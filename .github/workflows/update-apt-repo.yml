name: Update APT Repository

on:
  repository_dispatch:
    types: [package-updated, manual-package-upload]
  workflow_dispatch:
    inputs:
      package:
        description: 'Package name to update'
        required: false
        default: ''
      version:
        description: 'Package version'
        required: false
        default: ''
      source_repo:
        description: 'Source repository'
        required: false
        default: ''

permissions:
  contents: write
  pages: write
  id-token: write

env:
  REPO_NAME: sdwan-apt-repo
  CODENAME: jammy
  COMPONENTS: main
  ARCHITECTURES: amd64 arm64
  PAGES_URL: https://fivegen-llc.github.io/sdwan-apt-repo/

jobs:
  update-apt-repo:
    name: Update APT repository
    runs-on: ubuntu-latest
    outputs:
      artifact_id: ${{ steps.upload-artifact.outputs.artifact-id }}
      keyring: ${{ steps.create-apt-repo.outputs.keyring }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Install tools
        run: |
          set -euxo pipefail
          sudo apt update
          sudo apt install -y reprepro dpkg-dev wget gh
      
      - name: Make scripts executable
        run: chmod +x ./.github/workflows/scripts/*.sh
      
      - name: "Download artifact from triggering workflow (preferred)"
        if: github.event_name == 'repository_dispatch' && github.event.client_payload.run_id != ''
        uses: dawidd6/action-download-artifact@v6
        with:
          name: ${{ github.event.client_payload.artifact_name != '' && github.event.client_payload.artifact_name || 'deb-packages' }}
          path: packages
          repo: ${{ github.event.client_payload.source_repo }}
          run_id: ${{ github.event.client_payload.run_id }}
          github_token: ${{ secrets.GH_READ_TOKEN }}
        continue-on-error: true

      - name: "Manual upload: clone source repo and copy .deb (manual-package-upload)"
        if: github.event_name == 'repository_dispatch' && github.event.client_payload.source_repo != '' && github.event.client_payload.run_id == ''
        run: ./.github/workflows/scripts/manual_upload_fetch.sh "${{ github.event.client_payload.source_repo }}" packages

      - name: "Fallback: download from Release tag (no v prefix)"
        if: github.event_name == 'repository_dispatch' && github.event.client_payload.run_id == '' && github.event.client_payload.version != ''
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.event.client_payload.source_repo }}
          tag: ${{ github.event.client_payload.version }}
          fileName: "*.deb"
          out-file-path: packages
          token: ${{ secrets.GH_READ_TOKEN }}
        continue-on-error: true

      - name: "Download .deb packages manually (workflow_dispatch)"
        if: github.event_name == 'workflow_dispatch' && inputs.source_repo != '' && inputs.version != ''
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ inputs.source_repo }}
          tag: ${{ inputs.version }}
          fileName: "*.deb"
          out-file-path: packages
          token: ${{ secrets.GH_READ_TOKEN }}
        continue-on-error: true

      - name: "Verify packages exist"
        run: |
          set -euxo pipefail
          ls -la packages || true
          if [ -z "$(ls -1 packages/*.deb 2>/dev/null || true)" ]; then
            echo "No .deb packages found in packages/" >&2
            exit 1
          fi
      
      - name: Prepare working repo (import existing Pages content)
        run: ./.github/workflows/scripts/prepare_repo.sh "${{ env.PAGES_URL }}" "${{ env.CODENAME }}" "${{ env.COMPONENTS }}" "${{ env.ARCHITECTURES }}"

      - name: Include new packages (append-only)
        env:
          GNUPGHOME: /home/runner/.gnupg
        run: |
          set -euxo pipefail
          if [ -n "${{ secrets.APT_SIGNING_KEY }}" ]; then
            echo "${{ secrets.APT_SIGNING_KEY }}" | gpg --batch --import
            if [ -n "${{ secrets.APT_SIGNING_KEY_PASSPHRASE }}" ]; then
              echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
              echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
              gpgconf --reload gpg-agent
            fi
          fi
          ./.github/workflows/scripts/include_packages.sh "${{ env.CODENAME }}" packages

      - name: Prune old versions (keep last 3)
        run: ./.github/workflows/scripts/prune_versions.sh "${{ env.CODENAME }}" 3

      - name: Upload Pages artifact
        id: upload-artifact
        uses: actions/upload-pages-artifact@v3
        with:
          name: github-pages
          path: apt-repo

  deploy-apt-repo:
    name: Deploy APT repository
    runs-on: ubuntu-latest
    needs: update-apt-repo
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Adding APT repository summary
        run: |
          echo ':rocket: APT Repository Updated' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '**Updated packages:**' >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "- ${{ github.event.client_payload.package }} (${{ github.event.client_payload.version }})" >> $GITHUB_STEP_SUMMARY
            echo "- Source: ${{ github.event.client_payload.source_repo }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '**Installation instructions:**' >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'curl -sfLo /etc/apt/trusted.gpg.d/${{ needs.update-apt-repo.outputs.keyring }}.asc ${{ steps.deployment.outputs.page_url }}gpg.key' >> $GITHUB_STEP_SUMMARY
          echo 'echo "deb ${{ steps.deployment.outputs.page_url }} ${{ env.CODENAME }} ${{ env.COMPONENTS }}" >/etc/apt/sources.list.d/${{ env.REPO_NAME }}.list' >> $GITHUB_STEP_SUMMARY
          echo 'sudo apt update' >> $GITHUB_STEP_SUMMARY
          echo 'sudo apt install <package-name>' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

